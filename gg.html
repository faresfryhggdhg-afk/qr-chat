<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>💬 دردشة WebRTC عبر QR + إدخال يدوي (PC بلا كاميرا)</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --primary:#2563eb;--success:#065f46;--error:#7f1d1d;--gray:#6b7280;--bg:#f3f6fb
    }
    *{box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,sans-serif;margin:0;background:var(--bg);color:#1f2937}
    .wrap{max-width:1000px;margin:14px auto;background:#fff;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.08);overflow:hidden}
    header{background:var(--primary);color:#fff;padding:14px;text-align:center;font-weight:700}
    .content{padding:16px}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .col{flex:1;min-width:300px}
    h3{margin:0 0 8px}
    .btn{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600}
    .btn:hover{opacity:.95}
    .btn.secondary{background:#0f172a}
    .btn.light{background:#eef2ff;color:#1e40af}
    .btn.ghost{background:#f8fafc;color:#0f172a;border:1px solid #e5e7eb}
    .btn:disabled{background:#94a3b8;cursor:not-allowed}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    video{width:100%;max-height:280px;background:#000;border-radius:10px;display:none;margin-top:8px}
    .qr-box{display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;border:1px dashed #cbd5e1;border-radius:12px;padding:10px;min-height:260px;background:#f8fafc}
    .result{margin:8px 0;padding:10px;border-radius:8px;font-size:.95em;text-align:center}
    .success{background:#ecfdf5;color:var(--success)}
    .error{background:#fff1f2;color:var(--error)}
    .info{background:#eff6ff;color:var(--primary)}
    .note{font-size:.9em;color:var(--gray);background:#f1f5f9;padding:8px;border-radius:8px;margin:8px 0}
    .field{display:flex;flex-direction:column;gap:6px}
    textarea{width:100%;min-height:80px;resize:vertical;border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .copy-line{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .chat{display:none;flex-direction:column;height:450px;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;margin-top:16px}
    .status-bar{font-size:.95em;padding:8px 10px;background:#eff6ff;color:var(--primary);text-align:center}
    .msgs{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px;background:#f8fafc}
    .bubble{padding:10px 14px;border-radius:16px;max-width:78%;line-height:1.45;word-wrap:break-word}
    .me{align-self:flex-end;background:var(--primary);color:#fff}
    .other{align-self:flex-start;background:#f1f5f9;color:#0f172a}
    .msg-img{max-width:200px;border-radius:10px;cursor:pointer}
    .composer{display:flex;gap:8px;padding:8px;background:#fff;border-top:1px solid #e5e7eb}
    .composer textarea{flex:1;min-height:42px;max-height:120px}
    .tools{display:flex;gap:6px}
    .tools button{width:42px;height:42px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer}
    .loader{display:inline-block;width:16px;height:16px;border:2px solid #e5e7eb;border-top:2px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:520px){.wrap{margin:8px}.row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>🔐 دردشة WebRTC عبر QR + إدخال يدوي (تلائم PC بلا كاميرا)</header>
    <div class="content">
      <div id="globalStatus" class="result info" style="display:none"></div><div class="row">
    <!-- الطرف الأول -->
    <div class="col">
      <h3>الطرف الأول: إنشاء محادثة</h3>
      <div class="qr-box" id="qrOfferBox">
        <div class="note" style="text-align:center">اضغط <b>توليد Offer</b> ثم اعرض QR للهاتف لمسحه.</div>
        <div id="qrOffer"></div>
        <div id="offerSpinner" style="display:none"><span class="loader"></span></div>
      </div>
      <div class="stack" style="margin-top:8px">
        <button id="makeOfferBtn" class="btn"><i class="fas fa-qrcode"></i> توليد Offer (QR)</button>
        <button id="resetBtn" class="btn ghost"><i class="fas fa-arrows-rotate"></i> محادثة جديدة</button>
      </div>
      <div class="field" style="margin-top:10px">
        <label for="offerText">Offer (نص Base64) — للاستعمال اليدوي:</label>
        <textarea id="offerText" placeholder="سيظهر هنا الـ Offer كنص يمكن نسخه"></textarea>
        <div class="copy-line">
          <button id="copyOfferBtn" class="btn light"><i class="fas fa-copy"></i> نسخ Offer</button>
        </div>
      </div>
      <div class="field" style="margin-top:10px">
        <label for="answerText">Answer من الطرف الثاني (ألصق يدويًا إن لم تتوفر كاميرا على PC):</label>
        <textarea id="answerText" placeholder="ألصق هنا الـ Answer Base64 من الهاتف"></textarea>
        <div class="stack">
          <button id="applyAnswerBtn" class="btn secondary"><i class="fas fa-plug"></i> تطبيق Answer يدويًا</button>
          <button id="scanAnswerBtn" class="btn"><i class="fas fa-camera"></i> مسح Answer عبر كاميرا</button>
        </div>
      </div>
    </div>

    <!-- الطرف الثاني -->
    <div class="col">
      <h3>الطرف الثاني: الانضمام</h3>
      <video id="video" autoplay playsinline></video>
      <div id="scanStatus" class="result" style="display:none"></div>
      <div class="stack">
        <button id="scanOfferBtn" class="btn"><i class="fas fa-camera"></i> بدء مسح Offer</button>
        <button id="stopScanBtn" class="btn ghost"><i class="fas fa-stop"></i> إيقاف المسح</button>
      </div>

      <div class="note">إن لم تتوفر كاميرا على هذا الجهاز، يمكنك لصق الـ Offer يدويًا:</div>
      <div class="field">
        <label for="joinOfferText">Offer من الطرف الأول (Base64 أو webrtc://...):</label>
        <textarea id="joinOfferText" placeholder="ألصق هنا ثم اضغط إنشاء Answer"></textarea>
        <div class="stack">
          <button id="makeAnswerBtn" class="btn secondary"><i class="fas fa-reply"></i> إنشاء Answer</button>
        </div>
      </div>

      <div class="field" style="margin-top:10px">
        <label for="answerOutText">Answer الناتج (Base64 + QR):</label>
        <div class="qr-box" id="qrAnswerBox">
          <div id="qrAnswer"></div>
        </div>
        <textarea id="answerOutText" placeholder="سيظهر هنا Answer كنص"></textarea>
        <div class="copy-line">
          <button id="copyAnswerBtn" class="btn light"><i class="fas fa-copy"></i> نسخ Answer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- واجهة المحادثة -->
  <div class="chat" id="chatBox">
    <div class="status-bar" id="connStatus">جاري الإعداد...</div>
    <div class="msgs" id="msgs"></div>
    <div class="composer">
      <textarea id="msgInput" placeholder="اكتب رسالة..." rows="1"></textarea>
      <div class="tools">
        <button id="imgBtn" title="إرسال صورة"><i class="fas fa-image"></i></button>
        <button id="sendBtn" title="إرسال"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none" />
</div>

  </div> <!-- مكتبات --> <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script> <script src="https://unpkg.com/qr-scanner/qr-scanner.umd.min.js"></script> <script>
    // عناصر
    const qrOffer = document.getElementById('qrOffer');
    const qrAnswer = document.getElementById('qrAnswer');
    const offerSpinner = document.getElementById('offerSpinner');
    const makeOfferBtn = document.getElementById('makeOfferBtn');
    const resetBtn = document.getElementById('resetBtn');
    const offerText = document.getElementById('offerText');
    const copyOfferBtn = document.getElementById('copyOfferBtn');
    const answerText = document.getElementById('answerText');
    const applyAnswerBtn = document.getElementById('applyAnswerBtn');
    const scanAnswerBtn = document.getElementById('scanAnswerBtn');

    const video = document.getElementById('video');
    const scanStatus = document.getElementById('scanStatus');
    const scanOfferBtn = document.getElementById('scanOfferBtn');
    const stopScanBtn = document.getElementById('stopScanBtn');
    const joinOfferText = document.getElementById('joinOfferText');
    const makeAnswerBtn = document.getElementById('makeAnswerBtn');
    const answerOutText = document.getElementById('answerOutText');
    const copyAnswerBtn = document.getElementById('copyAnswerBtn');

    const chatBox = document.getElementById('chatBox');
    const msgsEl = document.getElementById('msgs');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const imgBtn = document.getElementById('imgBtn');
    const fileInput = document.getElementById('fileInput');
    const connStatus = document.getElementById('connStatus');
    const globalStatus = document.getElementById('globalStatus');

    let pc = null; // RTCPeerConnection
    let dc = null; // RTCDataChannel
    let scanner = null; // QrScanner

    // Helpers
    const enc = (obj) => btoa(JSON.stringify(obj));
    const dec = (str) => JSON.parse(atob(str));

    function showGlobal(msg, type='info'){
      globalStatus.textContent = msg; globalStatus.className = `result ${type}`; globalStatus.style.display='block';
    }
    function hideGlobal(){ globalStatus.style.display='none'; }

    function setConn(msg){ connStatus.textContent = msg; }

    function addMsg(content, me, isImage=false){
      const div = document.createElement('div');
      div.className = `bubble ${me?'me':'other'}`;
      if(isImage){
        const img = document.createElement('img');
        img.src = content; img.className = 'msg-img';
        img.onclick = () => window.open(content, '_blank');
        div.appendChild(img);
      } else {
        div.textContent = content;
      }
      msgsEl.appendChild(div); msgsEl.scrollTop = msgsEl.scrollHeight;
    }

    function cleanup(){
      if(scanner){ scanner.stop(); scanner.destroy(); scanner = null; }
      if(pc){ pc.close(); pc = null; }
      dc = null;
      video.style.display = 'none';
    }

    function setupDC(channel){
      dc = channel;
      dc.onopen = ()=> setConn('✅ متصل! يمكنك المراسلة الآن.');
      dc.onclose = ()=> setConn('❌ تم إغلاق القناة.');
      dc.onerror = (e)=> console.error('DC error:', e);
      dc.onmessage = (e)=>{
        try{
          const data = JSON.parse(e.data);
          if(data.type==='image'){ addMsg(data.src, false, true); }
          else { addMsg(data.text, false); }
        }catch{ addMsg(e.data, false); }
      };
    }

    // توليد Offer (الطرف الأول)
    async function makeOffer(){
      cleanup();
      makeOfferBtn.disabled = true;
      offerSpinner.style.display = 'block';
      qrOffer.innerHTML = '';
      offerText.value = '';

      pc = new RTCPeerConnection({
        iceServers:[
          {urls:'stun:stun.l.google.com:19302'},
          {urls:'stun:stun1.l.google.com:19302'}
        ]
      });
      setupDC(pc.createDataChannel('chat'));

      pc.onicecandidate = () => {
        if(pc.iceGatheringState === 'complete'){
          const encoded = enc(pc.localDescription);
          offerText.value = encoded;
          renderQR(qrOffer, 'webrtc://'+encoded);
          offerSpinner.style.display = 'none';
          showGlobal('📷 اعرض هذا الـ QR للهاتف لمسحه. إن لم تتوفر كاميرا على الهاتف، انسخ النص من مربع Offer.', 'info');
          makeOfferBtn.disabled = false;
          chatBox.style.display = 'flex';
          setConn('جاري الانتظار...');
        }
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
    }

    // تطبيق Answer للطرف الأول (يدويًا أو عبر ماسح على PC آخر)
    async function applyAnswerManual(){
      try{
        if(!pc) return showGlobal('أنشئ Offer أولاً.', 'error');
        const raw = answerText.value.trim();
        if(!raw) return showGlobal('ألصق Answer Base64 أولاً.', 'error');
        const ans = raw.startsWith('{')? JSON.parse(raw) : dec(raw);
        await pc.setRemoteDescription(ans);
        showGlobal('✅ تم تطبيق الـ Answer بنجاح.', 'success');
        setConn('يتم إكمال الاتصال...');
      }catch(e){ console.error(e); showGlobal('فشل في تطبيق الـ Answer.', 'error'); }
    }

    // مسح Answer بكاميرا هذا الجهاز (إن وُجدت)
    function scanAnswer(){ startScan((result)=>{
      if(result.startsWith('webrtc-answer://')){
        answerText.value = result.replace('webrtc-answer://','');
        applyAnswerManual();
      } else {
        showGlobal('رمز غير صالح: نحتاج webrtc-answer://', 'error');
      }
    }); }

    // الطرف الثاني: الانضمام عبر مسح Offer
    function scanOffer(){ startScan(async (result)=>{
      if(result.startsWith('webrtc://')){
        joinWithOfferStr(result.replace('webrtc://',''));
      } else { scanStatus.textContent='QR غير صالح'; scanStatus.className='result error'; scanStatus.style.display='block'; }
    }); }

    // بدء المسح العام
    function startScan(onResult){
      try{
        cleanup();
        video.style.display = 'block';
        scanStatus.style.display='block';
        scanStatus.className='result info';
        scanStatus.textContent='📷 مسح نشط... وجّه الكاميرا نحو QR';
        scanner = new QrScanner(video, (res)=>{ scanner.stop(); video.style.display='none'; onResult(res); }, {highlightScanRegion:true, highlightCodeOutline:true});
        scanner.start({facingMode:'environment'}).catch(err=>{
          console.error(err);
          scanStatus.textContent='تعذّر الوصول للكاميرا. استخدم الإدخال اليدوي.';
          scanStatus.className='result error';
          video.style.display='none';
        });
      }catch(e){ console.error(e); }
    }

    function stopScan(){ if(scanner){ scanner.stop(); scanner.destroy(); scanner=null; } video.style.display='none'; scanStatus.style.display='none'; }

    // الطرف الثاني: الانضمام عبر لصق Offer نصيًا
    async function makeAnswerFromPasted(){
      try{
        const raw = joinOfferText.value.trim();
        if(!raw) return showGlobal('ألصق Offer أولاً في خانة الانضمام.', 'error');
        const offer = raw.startsWith('{')? JSON.parse(raw) : dec(raw.replace(/^webrtc:\/\//,''));
        await joinWithOffer(offer);
      }catch(e){ console.error(e); showGlobal('Offer غير صالح.', 'error'); }
    }

    async function joinWithOfferStr(encoded){
      try{ const offer = dec(encoded); await joinWithOffer(offer); }
      catch(e){ console.error(e); showGlobal('فشل في قراءة الـ Offer.', 'error'); }
    }

    async function joinWithOffer(offer){
      cleanup();
      pc = new RTCPeerConnection({
        iceServers:[
          {urls:'stun:stun.l.google.com:19302'},
          {urls:'stun:stun1.l.google.com:19302'}
        ]
      });
      pc.ondatachannel = (e)=> setupDC(e.channel);
      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      // بعد اكتمال ICE اجمع الـ answer النهائي
      const waitIceComplete = new Promise((resolve)=>{
        const t = setInterval(()=>{
          if(pc && pc.iceGatheringState==='complete'){ clearInterval(t); resolve(); }
        }, 100);
      });
      await waitIceComplete;

      const encoded = enc(pc.localDescription);
      answerOutText.value = encoded;
      renderQR(qrAnswer, 'webrtc-answer://'+encoded);
      showGlobal('✅ أنشأنا Answer. اعرض QR للطرف الأول أو انسخ النص.', 'success');

      chatBox.style.display='flex';
      setConn('جاري الانتظار...');
    }

    // رسم QR
    function renderQR(container, data){
      container.innerHTML='';
      QRCode.toCanvas(data, {width:230}, (err, canvas)=>{
        if(err){ console.error(err); showGlobal('فشل في إنشاء QR', 'error'); return; }
        container.appendChild(canvas);
      });
    }

    // إرسال رسالة
    function sendMsg(){
      const text = msgInput.value.trim();
      if(!text || !dc || dc.readyState!=='open') return;
      dc.send(JSON.stringify({type:'text', text}));
      addMsg(text, true);
      msgInput.value='';
    }

    // إرسال صورة
    function sendImage(file){
      if(!file || !dc || dc.readyState!=='open') return;
      const reader = new FileReader();
      reader.onload = ()=>{
        const base64 = reader.result;
        dc.send(JSON.stringify({type:'image', src: base64}));
        addMsg(base64, true, true);
      };
      reader.readAsDataURL(file);
    }

    // نسخ للحافظة
    async function copyText(el){
      try{
        await navigator.clipboard.writeText(el.value);
        showGlobal('📋 تم النسخ إلى الحافظة.', 'success');
      }catch{
        el.select(); document.execCommand('copy');
        showGlobal('📋 تم النسخ (fallback).', 'success');
      }
    }

    // إعادة البدء
    function resetAll(){
      cleanup();
      qrOffer.innerHTML=''; qrAnswer.innerHTML='';
      offerText.value=''; answerText.value=''; joinOfferText.value=''; answerOutText.value='';
      hideGlobal(); scanStatus.style.display='none';
      chatBox.style.display='none'; msgsEl.innerHTML='';
      setConn('جاري الإعداد...');
    }

    // أحداث الواجهة
    makeOfferBtn.onclick = makeOffer;
    resetBtn.onclick = resetAll;
    copyOfferBtn.onclick = ()=> copyText(offerText);
    copyAnswerBtn.onclick = ()=> copyText(answerOutText);
    applyAnswerBtn.onclick = applyAnswerManual;
    scanAnswerBtn.onclick = scanAnswer;
    scanOfferBtn.onclick = scanOffer;
    stopScanBtn.onclick = stopScan;
    makeAnswerBtn.onclick = makeAnswerFromPasted;

    sendBtn.onclick = sendMsg;
    msgInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMsg(); }});
    imgBtn.onclick = ()=> fileInput.click();
    fileInput.onchange = (e)=> sendImage(e.target.files[0]);

    // تحذير HTTPS
    document.addEventListener('DOMContentLoaded', ()=>{
      if(!window.isSecureContext && location.protocol !== 'http:'){
        showGlobal('⚠️ للوصول للكاميرا نحتاج HTTPS. GitHub Pages مناسب.', 'error');
      }
    });
  </script></body>
</html>
